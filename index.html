<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="vendor/codemirror/codemirror.css">
<link rel="stylesheet" href="vendor/font-awesome/css/font-awesome.css">
<link rel="stylesheet" href="codemirror-faded.css">
<style>
* {
  -moz-box-sizing: border-box;
  -webkit-box-sizing: border-box;
  box-sizing: border-box;
}

.hackable {
  background: yellow;
  border: 1px solid black;
  border-radius: 0;
  padding: 0 4px;
  font-family: inherit;
  font-size: inherit;
}

.CodeMirror {
  height: auto;
}

.CodeMirror-scroll {
  overflow-x: auto;
  overflow-y: hidden;
}

ul.toolbar {
  list-style-type: none;
  padding: 0;
}

ul.toolbar li {
  display: inline-block;
}

ul.toolbar li a {
  display: inline-block;
  padding: 10px;
  text-decoration: none;
  color: black;
}

ul.toolbar li a[role="run"] {
  background: green;
  color: white;
}

#iframe-holder {
  z-index: 5000;
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: white;
  width: 100%;
  height: 100%;
}

#iframe-holder iframe {
  display: block;
  border: none;
  width: 100%;
  height: 100%;
}

#iframe-holder a[role="stop"] {
  display: block;
  padding: 10px;
  position: absolute;
  top: 0;
  right: 0;
  z-index: 5001;
  background: red;
  color: white;
  text-decoration: none;
}
</style>
<title>EZHack</title>
<div id="editor">
<p>You can safely edit <em>parts</em> of the the HTML, CSS, and JavaScript below by tinkering with widgets embedded in the source code.</p>
<ul class="toolbar">
  <li>
    Edit:
    <select id="hackables">
      <option value="flyswat">Flyswat</option>
      <option value="poundsplat">Poundsplat</option>
      <option value="type-the-word">Type The Word</option>
      <option value="what-colour">What Colour Is It?</option>
    </select>
  </li>
  <li><a href="#" role="run" title="Run the program (Ctrl+space)"><i class="fa fa-play"></i> Run</a></li>
</ul>
<div id="code"></div>
</div>
<div id="iframe-holder" style="display: none">
  <a href="#" role="stop" title="Stop the program (ESC)"><i class="fa fa-stop"></i> Stop</a>
</div>
<script src="vendor/jquery.js"></script>
<script src="vendor/cancel-zoom.js"></script>
<script src="vendor/codemirror/codemirror.js"></script>
<script src="vendor/codemirror/xml.js"></script>
<script src="vendor/codemirror/css.js"></script>
<script src="vendor/codemirror/javascript.js"></script>
<script src="vendor/codemirror/htmlmixed.js"></script>
<script src="vendor/jscolor/jscolor.js"></script>
<script>
function ColorWidget(options) {
  Object.defineProperty(this, 'value', {
    get: this._getValue,
    set: this._setValue
  });

  this.codeMirror = options.codeMirror;
  this.title = options.title;
  this._buildWidget(options.from, options.to, options.defaultValue);
}

ColorWidget.prototype = {
  _buildWidget: function(from, to, value) {
    this.$el = $('<input class="hackable"></input>')
      .attr('title', this.title || 'Click to edit color.');
    this.el = this.$el[0];
    this.marker = this.codeMirror.markText(from, to, {
      replacedWith: this.el
    });
    this.picker = new jscolor.color(this.el, {hash: true});
    this.$el.cancelZoom();
    this.value = value || this.codeMirror.getRange(from, to);
  },
  _getValue: function() {
    return this.picker.toString();
  },
  _setValue: function(newValue) {
    this.picker.fromString(newValue);
    this.marker.changed();
  },
  reflect: function() {
    // Reflect our current value into the code.
    //
    // Strangely, there is no way to change the value of the underlying
    // code that our marker points at without destroying the marker too,
    // so we'll need to rebuild our marker and associated widget.

    var where = this.marker.find();
    var value = this.value;
    this.marker.clear();
    this.codeMirror.replaceRange(value, where.from, where.to);
    var newTo = this.codeMirror.posFromIndex(
      this.codeMirror.indexFromPos(where.from) + value.length
    );
    this._buildWidget(where.from, newTo);
  }
};

var hackables = {
  'type-the-word': function(codeMirror) {
    return {
      'winbg': new ColorWidget({
        from: {line:9, ch:22},
        to: {line:9, ch:29},
        title: 'Background color for win screen.',
        codeMirror: codeMirror
      }),
      'losebg': new ColorWidget({
        from: {line: 13, ch: 22}, to: {line: 13, ch: 29},
        title: 'Background color for lose screen.',
        codeMirror: codeMirror
      }),
      'lettercolor': new ColorWidget({
        from: {line: 36, ch: 11}, to: {line: 36, ch: 16},
        title: 'Color of letters to be typed.',
        defaultValue: '#000000',
        codeMirror: codeMirror
      })
    };
  }
};

function setupDebugFunctionality(codeMirror, fields) {
  // Press CTRL+SHIFT+SPACE to see selection extents.
  $(codeMirror.getWrapperElement()).on('keyup', function(e) {
    if (e.which == 32 && e.ctrlKey && e.shiftKey) {
      e.preventDefault();
      if (!codeMirror.somethingSelected()) return;
      var sel = {
        from: codeMirror.getCursor('from'), 
        to: codeMirror.getCursor('to')
      };
      window.prompt('Selection is:',
                    'from: {line: ' + sel.from.line + ', ' +
                           'ch: ' + sel.from.ch + '}, ' +
                    'to: {line: ' + sel.to.line + ', ' +
                         'ch: ' + sel.to.ch + '}');
    }
  });

  // These should be accessed for debugging ONLY.
  window.f = fields;
  window.c = codeMirror;
}

function stopGame() {
  $('#iframe-holder').hide().find('iframe').remove();
  $('#editor').show();
}

function runGame(url, codeMirror, fields) {
  $('#iframe-holder').find('iframe').remove();
  Object.keys(fields).forEach(function(fieldName) {
    fields[fieldName].reflect();
  });
  var html = codeMirror.getValue();
  var iframe = document.createElement('iframe');
  $('#iframe-holder').show().prepend(iframe);
  var doc = iframe.contentDocument;
  doc.open();
  doc.write('<base href="' + url + '">');
  doc.write(html);
  doc.close();
  setupGlobalKeybindings(iframe.contentWindow);
  iframe.focus();
  $('#editor').hide();
  window.scrollTo(0, 0);
}

function setupGlobalKeybindings(targetWindow) {
  targetWindow.addEventListener('keyup', function(e) {
    if (e.which == 27) {
      e.preventDefault();
      stopGame();
      $(window).focus();
    } else if (e.which == 32 && e.ctrlKey && !e.shiftKey) {
      e.preventDefault(); 
      $('a[role="run"]').click();
    }
  }, false);
}

$(function() {
  var hackable = 'type-the-word';
  var hackableURL;

  try {
    hackable = window.location.search.match(/hackable=([A-Za-z0-9\-]+)/)[1];
  } catch (e) {}

  hackableURL = 'hackables/' + hackable + '/index.html';
  $('#hackables')
    .val(hackable)
    .on('change', function() {
      window.location.search = '?hackable=' + this.value;
    })
    .cancelZoom();

  $.get(hackableURL, function(html) {
    var cm = CodeMirror($('#code')[0], {
      mode: 'htmlmixed',
      lineNumbers: true,
      lineWrapping: true,
      readOnly: true,
      viewportMargin: Infinity,
      theme: 'default faded',
      value: html
    });
    var fields = hackable in hackables ? hackables[hackable](cm) : null;

    $(cm.getInputField()).cancelZoom();
    setupDebugFunctionality(cm, fields);
    setupGlobalKeybindings(window);

    $('a[role="stop"]').click(function(e) {
      e.preventDefault();
      stopGame();
    });

    $('a[role="run"]').click(function(e) {
      e.preventDefault();
      runGame(hackableURL, cm, fields);
    });
  });
});
</script>
