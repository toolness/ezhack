<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=600, initial-scale=1">
<link rel="stylesheet" href="vendor/codemirror/codemirror.css">
<style>
* {
  -moz-box-sizing: border-box;
  -webkit-box-sizing: border-box;
  box-sizing: border-box;
}

.hackable {
  background: yellow;
  border: 1px solid black;
  border-radius: 0;
  padding: 0 4px;
  font-family: inherit;
  font-size: inherit;
}

.CodeMirror {
  height: auto;
}

.CodeMirror-scroll {
  overflow-x: auto;
  overflow-y: hidden;
}

.cm-s-faded { color: gray; }
.cm-s-faded .cm-keyword {opacity: 0.66;}
.cm-s-faded .cm-atom {opacity: 0.66;}
.cm-s-faded .cm-number {opacity: 0.66;}
.cm-s-faded .cm-def {opacity: 0.66;}
.cm-s-faded .cm-variable,
.cm-s-faded .cm-punctuation,
.cm-s-faded .cm-property,
.cm-s-faded .cm-operator {opacity: 0.66;}
.cm-s-faded .cm-variable-2 {opacity: 0.66;}
.cm-s-faded .cm-variable-3 {opacity: 0.66;}
.cm-s-faded .cm-comment {opacity: 0.66;}
.cm-s-faded .cm-string {opacity: 0.66;}
.cm-s-faded .cm-string-2 {opacity: 0.66;}
.cm-s-faded .cm-meta {opacity: 0.66;}
.cm-s-faded .cm-qualifier {opacity: 0.66;}
.cm-s-faded .cm-builtin {opacity: 0.66;}
.cm-s-faded .cm-bracket {opacity: 0.66;}
.cm-s-faded .cm-tag {opacity: 0.66;}
.cm-s-faded .cm-attribute {opacity: 0.66;}
.cm-s-faded .cm-header {opacity: 0.66;}
.cm-s-faded .cm-quote {opacity: 0.66;}
.cm-s-faded .cm-hr {opacity: 0.66;}
.cm-s-faded .cm-link {opacity: 0.66;}

ul.hackables {
  list-style-type: none;
  padding: 0;
}

ul.hackables li {
  display: inline-block;
  border: 1px dotted gray;
}

ul.hackables li a {
  display: inline-block;
  padding: 10px;
  text-decoration: none;
  color: black;
}

ul.hackables li a.selected {
  background: yellow;
  pointer-events: none;
}
</style>
<title>EZHack</title>
<p>You can safely edit <em>parts</em> of the the HTML, CSS, and JavaScript below by tinkering with widgets embedded in the source code.</p>
<ul class="hackables">
  <li><a href="?hackable=flyswat">flyswat</a></li>
  <li><a href="?hackable=poundsplat">poundsplat</a></li>
  <li><a href="?hackable=type-the-word">type-the-word</a></li>
  <li><a href="?hackable=what-colour">what-colour</a></li>
</ul>
<div id="code"></div>
<script src="vendor/jquery.js"></script>
<script src="vendor/codemirror/codemirror.js"></script>
<script src="vendor/codemirror/xml.js"></script>
<script src="vendor/codemirror/css.js"></script>
<script src="vendor/codemirror/javascript.js"></script>
<script src="vendor/codemirror/htmlmixed.js"></script>
<script src="vendor/jscolor/jscolor.js"></script>
<script>
function ColorWidget(options) {
  Object.defineProperty(this, 'value', {
    get: this._getValue,
    set: this._setValue
  });

  this.codeMirror = options.codeMirror;
  this.title = options.title;
  this._buildWidget(options.from, options.to);
}

ColorWidget.prototype = {
  _buildWidget: function(from, to) {
    this.$el = $('<input class="hackable"></input>')
      .attr('title', this.title || 'Click to edit color.');
    this.el = this.$el[0];
    this.marker = this.codeMirror.markText(from, to, {
      replacedWith: this.el
    });
    this.picker = new jscolor.color(this.el, {});
    this.value = this.codeMirror.getRange(from, to);
  },
  _getValue: function() {
    return this.picker.toString();
  },
  _setValue: function(newValue) {
    this.picker.fromString(newValue);
    this.marker.changed();
  },
  reflect: function() {
    // Reflect our current value into the code.
    //
    // Strangely, there is no way to change the value of the underlying
    // code that our marker points at without destroying the marker too,
    // so we'll need to rebuild our marker and associated widget.

    var where = this.marker.find();
    var value = this.value;
    this.marker.clear();
    this.codeMirror.replaceRange(value, where.from, where.to);
    var newTo = this.codeMirror.posFromIndex(
      this.codeMirror.indexFromPos(where.from) + value.length
    );
    this._buildWidget(where.from, newTo);
  }
};

var hackables = {
  'type-the-word': function(codeMirror) {
    return {
      'winbg': new ColorWidget({
        from: {line:9, ch:23},
        to: {line:9, ch:29},
        codeMirror: codeMirror
      })
    };
  }
};

function setupDebugFunctionality(codeMirror, fields) {
  // Press CTRL+SPACE to see selection extents.
  $(codeMirror.getWrapperElement()).on('keypress', function(e) {
    if (e.which == 32 && e.ctrlKey) {
      e.preventDefault();
      if (!codeMirror.somethingSelected()) return;
      var sel = {
        from: codeMirror.getCursor('from'), 
        to: codeMirror.getCursor('to')
      };
      window.prompt('Selection is:',
                    'from: {line: ' + sel.from.line + ', ' +
                           'ch: ' + sel.from.ch + '}, ' +
                    'to: {line: ' + sel.to.line + ', ' +
                         'ch: ' + sel.to.ch + '}');
    }
  });

  // These should be accessed for debugging ONLY.
  window.f = fields;
  window.c = codeMirror;
}

$(function() {
  var hackable = 'type-the-word';

  try {
    hackable = window.location.search.match(/hackable=([A-Za-z0-9\-]+)/)[1];
  } catch (e) {}

  $.get('hackables/' + hackable + '/index.html', function(html) {
    var cm = CodeMirror($('#code')[0], {
      mode: 'htmlmixed',
      lineNumbers: true,
      lineWrapping: true,
      readOnly: true,
      viewportMargin: Infinity,
      theme: 'default faded',
      value: html
    });
    var fields = hackable in hackables ? hackables[hackable](cm) : null;

    $('a[href="?hackable=' + hackable + '"]').addClass('selected');
    setupDebugFunctionality(cm, fields);
  });
});
</script>
